{{> layout/header}}
<style>
</style>

<div class="container sub-page" style="text-align: center">
    <div class="cart-w d-flex">
        <div class="cart-L">
            <table class="table table-striped" style="vertical-align: middle">
                <tr>
                    <th>번호</th>
                    <th>상품명</th>
                    <th>구매수량</th>
                    <th>상품가격</th>
                    <th>총액</th>
                    <th>선택하기</th>
                </tr>

            <tr class="cart-table my-cart-list" id="cart-id">
                {{#cartList}}
                    <td>1</td>
                    <td>
                        <div style="width:150px; margin:0 auto;">
                            <img src="/upload/{{img}}" alt="Product Image" style="max-width: 100%; max-height: 100%;">
                        </div>
                        {{pName}}
                    </td>

                    <td colspan="2">
                        <!-- 상품의 구매 수량만큼 표시됩니다 value 명에 변수 값만 넣어주세요-->
                        <div class="quantity-controls d-flex"
                             style="width: 100px; text-align: center; ">
                            <button type="button" class="decrease-btn" aria-label="수량내리기" style="">-
                            </button>
                            <input type="text" class="quantity" name="orderQty" value="{{orderQty}}"
                                   style="text-align: center; ">
                            <button type="button" class="increase-btn" aria-label="수량올리기">+</button>
                        </div>
                    </td>

                    <td>{{price}}</td>

                    <td>총가격</td>

                    <td>
                        <input class="form-check-input product-checkbox item-check" type="checkbox" name="itemCheck"
                               id="itemCheck-id" style="width:20px !important; margin: 0 auto">
                    </td>
                </tr>
                {{/cartList}}

            </table>

            <button type="button" class="btn btn-warning" id="purchaseButton" style="width:300px">주문하기</button>

        </div>
    </div>
</div>

<script>
    let cartSaveList = [];

    document.querySelector("#purchaseButton").addEventListener("click", function (e) {
        e.preventDefault(); // 기본 폼 제출을 방지

        let checkedCarts = [];

        // 선택된 상품을 확인하고 리스트에 추가
        document.querySelectorAll(".item-check:checked").forEach(checkbox => {
            let cartId = checkbox.id.split('-')[1];
            let orderQty = document.querySelector(`#cart-${cartId} .cart-qty`).value;

            let checkedCart = {
                cartId: cartId,
                orderQty: orderQty,
                status: checkbox.checked ? true : false // 체크 여부에 따라 상태 설정
            };

            checkedCarts.push(checkedCart);
        });

        console.log(checkedCarts);

        // AJAX 요청으로 선택된 상품을 서버로 전송
        $.ajax({
            url: '#',
            data: JSON.stringify(checkedCarts),
            contentType: 'application/json; charset=utf-8',
            type: 'POST'
        }).done((res) => {
            alert(`결과: ${res}`);
            location.href = "#";
        }).fail((res) => {
            // 오류 처리
        });
    });
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // 수량 증가 버튼 클릭 이벤트
        $(".increase-btn").click(function () {
            var $quantityInput = $(this).siblings(".quantity");
            var currentQuantity = parseInt($quantityInput.val());
            $quantityInput.val(currentQuantity + 1);
        });

        // 수량 감소 버튼 클릭 이벤트
        $(".decrease-btn").click(function () {
            var $quantityInput = $(this).siblings(".quantity");
            var currentQuantity = parseInt($quantityInput.val());
            if (currentQuantity > 1) {
                $quantityInput.val(currentQuantity - 1);
            }
        });

        // 재고 수량 계산하여 표시
        var productQty = parseInt("{qty}}");
        var orderQty = parseInt($(".quantity").val());
        var remainingQty = productQty - orderQty;
        $(".remaining-qty").text("재고 수량: " + remainingQty);
    });
</script>

<script src="/js/sum-calculate.js"></script>
<script src="/js/list.js"></script>
<script src="/js/check-all.js"></script>

{{> layout/footer}}